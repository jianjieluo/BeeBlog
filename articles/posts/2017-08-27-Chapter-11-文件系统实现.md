@(Operating System)

# Chapter 11 文件系统实现

[toc]

最重要是要实现按名存取。

### 11.1 文件系统结构

为了改善I/O效率，内存和磁盘之间的I/O转移是以*块*为单位而不是以字节为单位来进行的。为了提供对磁盘的高效且便捷的访问，OS通过**文件系统**来轻松地存储、定位、提取数据。文件系统有两个不同的设计问题。一是如何定义文件系统对用户的接口，二是创建数据结构和算法来将逻辑文件系统映射到物理外存设备上。

文件系统本身通常由许多不同的层组成，使用分层设计。每层利用较低层的功能创建新的功能。
- I/O控制 为最底层，由**设备驱动程序**和**中断处理程序**组成，实现内存与磁盘之间的信息传输
- **基本文件系统**只需要向合适的设备驱动程序发送一般命令就可对磁盘上的物理块进行读写。
- **文件组织模块（file-organization module）**知道文件及其逻辑块和物理块。由于知道所使用的文件分配类型和文件的位置，文件组织模块可以**将逻辑块地址转换成基本文件系统所用的物理块地址**。文件组织模块也包括空闲空间管理器。
- 最后，**逻辑文件系统**管理元数据。元数据包括文件系统的所有结构数据，而不包括实际数据（或文件内容）。**逻辑文件系统根据给定符号文件名来管理目录结构**，并提供给文件组织模块所需要的信息。逻辑文件系统通过文件控制块来维护文件结构。

文件控制块（file control block, FCB）
:	包含文件的信息，如拥有者、权限、文件内容的位置。

###11.2 文件系统实现

在磁盘上，文件系统可能包括如下信息：如何启动所存储的操作系统、总的块数、空闲块的数目和位置、目录结构以及各个具体文件等。

生磁盘和熟磁盘，区别在于有没有文件操作系统在磁盘上。

### 11.2.3 虚拟文件系统

通过VFS接口统一接口区分不同的文件系统。

###11.3 目录实现
目录提供从文件名到数据块指针的映射

1. 线性列表：存储文件名和数据块指针的线性列表（linear list）
	- 优点：编程简单
	- 缺点：运行时较为耗时，查找文件需要线性搜索
2. 哈希表：在线性列表的基础上加上一个哈希数据结构。**哈希表根据文件名得到一个值，并返回一个只想线性列表中元素的指针，大大减少了目录搜索时间。**插入和删除也较简单，不过需要一些预备措施来避免冲突（两个文件名哈希到相同的位置）。
	- 最大困难：其通常固定的大小和哈希函数对大小的依赖性。

###11.4 分配方法
连续分配、链接分配、索引分配。这个是讲怎么为一个文件分配存储块

####11.4.1 连续分配
文件的连续分配可以用第一块的磁盘地址和连续块的数量来定义。

![Contiguous_allocation](http://or5jajfqs.bkt.clouddn.com/osnote/chapter11/Contiguous_allocation.jpg)

优点：简单，支持顺序访问和直接访问，顺序存取速度快
缺点：会产生外部碎片

解决方法：合并(compact)，解决碎片问题；当空间不够时，另一块被称为**扩展(extent)**的连续空间会添加到原来的分配中。

####11.4.2 链接分配

解决了连续分配的所有问题。目录包括文件第一块的指针和最后一块的指针。每块都有一个指向下一块的指针。用户不能使用这些指针。

![Linked_allocation](http://or5jajfqs.bkt.clouddn.com/osnote/chapter11/Linked_allocation.jpg)

优点：无外部碎片
缺点：只能顺序访问，不能直接访问；指针需要空间；稳定性不佳；存取速度慢

解决方案：将多个块组成簇（cluster），并按簇而不是按块分配，代价是增加了内部碎片。

变种：**文件分配表**（file allocation table, FAT），最大好处是顺序访问转成了随机访问：先读块号进内存里面找块号，再去磁盘找即可。有点像数组链表。

![FAT](http://or5jajfqs.bkt.clouddn.com/osnote/chapter11/FAT.png)

####11.4.3 索引分配

索引分配（indexed allocation）通过把所有指针放在一起，即通过**索引块**解决了链接分配不能有效支持直接访问的问题。

索引块
:	每个文件都有索引块，这是一个磁盘块地址的数组。索引块第i个条目指向文件的第i个块。目录条目包括索引块的地址。要读第i块，通过索引块的第i个条目的指针来查找和读入所需的块。这一方法类似于8.4节的分页方案。

![Indexed_allocation](http://or5jajfqs.bkt.clouddn.com/osnote/chapter11/Indexed_allocation.jpg)

优点：无外部碎片；支持直接访问
缺点：浪费空间，指针开销比链接分配的还大；需要两次读取

在索引块的基础上，为了处理大文件，需要做出一些优化
1. 链接方案：将多个索引块链接起来（链表）
2. 多层索引：第一层索引块指着第二层索引块，第二层索引块再指向文件块。
3. 组合方案：综合以上两种方案，UNIX将索引块的头15个指针存入文件的inode中，其中前12个指针指向直接块，其他3个指针指向间接块，依次是一级、二级和三级间接块。

![Unix_inode](http://or5jajfqs.bkt.clouddn.com/osnote/chapter11/Unix_inode.png)

这里要明白，一级指向的也是一个数据项，只不过全都用来存指针了，而那12个指针指的数据项直接存的是数据本身。二级三级可以类推，中间的那些数据项都用来存指针了

### 11.4.4 性能

不管什么类型的访问，连续分配需要访问一次就能得到磁盘块。链接分配就要沿着指针一个个去找了。索引分配更为复杂。如果索引块已经在内存中，那么可以直接访问。不过，将索引块保存在内存中需要相当大的空间。如果内存空间不够，那么可能必须先读入索引块，再读入所需的数据块。

## 11.5 空闲空间管理

为了记录空闲磁盘空间，系统需要维护一个**空闲空间链表（free-space list）**

1. 位向量：每块用一位来表示，空闲为1，已分配为0
	2. 优点：查找第一个空闲块和n个连续空闲块时相对简单和高效。
	3. 缺点：除非整个位向量都能保存在内存中，否则位向量的效率就不高。
2. 链表：将所有空闲磁盘块用链表链接起来。
	3. 优：存头指针即可，占用空间少
	4. 缺：遍历麻烦效率低
3. 组（grouping）：一组n块，每组第一块都存前以组的所有的块号。
4. 计数：通常，有多个连续块需要同时分配或者释放。因此，不是记录n个空闲块的地址，而是记录第一块的地址和紧跟第一块的连续的空闲块的数量n。

## 11.6 效率和性能

### 11.6.1 效率

磁盘空间的有效使用主要取决于所使用的磁盘分配和目录管理算法。

### 11.6.2 性能

缓冲缓存、页面缓存

## 11.7 恢复（略）