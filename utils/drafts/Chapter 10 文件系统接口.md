@(Operating System)

[toc]

# Chapter 10 文件系统接口

## 10.1 文件概念

文件是记录在外存上的相关信息的具有名称的集合。

文件属性：
1. 名称
2. 标识符
3. 类型
4. 位置
5. 大小
6. 保护
7. 时间、日期、和用户标识

所有文件的信息都保存在**目录结构**中，而目录结构也保存在外存上。

文件操作：
1. 创建
2. 读
3. 写
4. 在文件内重定位，该文件操作也称为*文件寻址*(seek)
5. 删除
6. 截短文件

以上所述的绝大多数文件操作都涉及为给定文件搜索相关目录条目。为了避免这中不断的搜索操作，许多系统要求在首次使用文件时，需要使用系统调用`open()`。操作系统维护一个包含所有打开文件的信息表（**打开文件表**， open-file table）。当需要一个文件操作时，可通过该表的一个索引指定文件，而不需要搜索.当文件不再使用的时候,进程关闭然后操作系统从打开文件表中删除这一条目.系统调用`open()`通常返回一个只想打开文件表中的一个条目的指针.通过使用该指针,而不是真实文件名称,进行所有I/O操作.

每个打开文件有一下相关信息:
1. 文件指针
2. 文件打开计数器
3. 文件磁盘位置
4. 访问权限

### 10.1.3 文件类型

实现文件类型的常用技术是在文件名称内包含类型。名称分为两部分：名称和扩展名

## 10.2 访问方法

1. 顺序访问：文件信息按照顺序，一个记录接着一个记录地加以处理。基于文件的磁带模型
2. 直接访问（或相对访问或随机存取）：文件由固定长度的**逻辑记录**组成，以允许程序按任意顺序进行快速读和写。基于文件的磁盘模型，这是因为磁盘允许对任意文件块进行随机读和写。对于直接访问的文件，读写顺序是没有限制的。直接访问文件可立即访问大量信息，所以极为有用。
3. 其他访问方式：索引，索引包括各块的指针。为了查找文件中的记录，首先搜索索引，再根据指针直接访问文件，以查找到所需要的记录。可以构建一个索引的二分搜索，通过这个搜索，可以精确地知道哪个块包括所要的记录并访问该块。

由用户相操作系统所提供的块号通常为**相对块号**。相对快哈喔屎相对于文件开始的索引。因此，文件的第一块的号码是0，下一块为1，依次类推，而第一块的真正绝对磁盘地址可能为14703，下一块为3192等。使用相对块号允许操作系统决定该文件放在哪里（称为*分配问题*，将在第11章中讨论），以阻止用户访问不属于其文件的其他的文件系统部分。

## 10.3 目录结构

为了管理所有这些数据，需要组织它们。这种管理涉及使用目录。首先，需要解释存储结构的基本特点

### 10.3.1 存储结构

磁盘（或任何足够打的存储设备）可以整体地用于一个文件系统。但是，又是需要再一个磁盘上装多种文件系统，或一部分用于文件系统而另一部分用于其他地方，如交换空间或非格式化的磁盘空间。这些部分称为**分区**或**片**，或称为**小型磁盘**。每个磁盘分区可以创建一个文件系统。这些部分可以组合称更大的可称为**卷(volume)**的结构，也可以在其上创建文件系统。现在，为了简单起见，可以将存储文件系统的一大块存储空间作为卷。卷可以存放多个操作系统，使系统启动和运行多个操作系统。

包含文件系统的每个卷还必须包含系统上文件的信息。这些信息保存在**设备目录**或**卷表**中。设备目录（常简称为目录）记录卷上所有文件的信息如名称、位置、大小和类型等。

![typical_file_system_organization|center](http://or5jajfqs.bkt.clouddn.com/osnote/chapter10/typical_file_system_organization.png)

### 10.3.2 目录概述

**目录可看作符号表，它能将文件名称转换称目录条目。**再考虑特定的目录结构时，需要记住目录的相关操作：
1. 搜索文件
2. 创建文件
3. 删除文件
4. 遍历目录
5. 重命名文件
6. 跟踪文件系统

### 10.3.3 单层目录结构
所有文件都包含在同一目录中（如七牛云）


优点：简单，便于理解和支持
缺点：对命名有严格限制，随着文件数量的增加，多用户很难记住所有的自己文件的名字。通常会在不同用户之间引起文件名称的混淆。标注的解决方法是为每个用户创建*独立目录*


### 10.3.4 双层结构目录

在单层目录的基础上为每个用户提供一个专属的**用户文件目录**（user file directory, UFD），每个URFD都有相似的结构，但只列出了单个用户的文件。当一个用户作业开始执行或一个用户注册时，就搜索系统的**主文件目录（master file directory, MFD）**。通过用户名或账号可缩影MFD，每个条目指向用户的UFD。

当一个用户引用特定文件时，只需要搜索他自及的UFD。因此，不同的用户可拥有具有相同名称的文件，只要每个UFD内的所有文件名称唯一即可。

![Single_level_directory|center](http://or5jajfqs.bkt.clouddn.com/osnote/chapter10/Single_level_directory.png)

缺点：在用户需要在某个任务上进行合作或者访问其他目录时是一个缺点。

### 10.3.5 树状结构目录

就是现在的系统普遍都在用的那种，将目录结构扩展为任意高度的树。这允许用户创建自及的子目录，相应地组织文件。树由根目录，系统内的每个文件都有唯一路径名。

目录（或子目录）包括一组文件和子目录。每个目录条目都用以为来定义其为文件（0）或子目录（1）.

![Tree_structured_directory_structure](http://or5jajfqs.bkt.clouddn.com/osnote/chapter10/Tree_structured_directory_structure.png)

当前目录
:	当前目录包括进程当前感兴趣的绝大多数文件。

在通常情况下，每个进程都有一个当前目录。当需要引用一个文件时，就搜索当前目录。如果需要文件不在当前目录中，那么用户必须指定路径名或将当前目录修改为包括所需文件的目录。

路径名有两种形式：绝对路径名和相对路径名。**绝对路径名**从根开始给出路径上的目录名知道所指定的文件。**相对路径名**从当前目录开始定义路径。

### 10.3.6 无环图目录

通过软硬链接来实现文件的共享。注意的问题是删除。


### 10.3.7 通用图目录

当对已存在的树状结构目录增加链接是，树状结构就被破坏了，产生了简单的图结构。注意避免多次搜索同一部分。

## 10.4 文件系统安装

文件系统在被系统上的进程使用之前必须**安装(mount)**。具体地说，目录结构可以建立在多个卷上，这些卷必须被安装以使他们在文件系统命名空间中可用。安装步骤相对建党。操作系统需要知道设备名称和文件系统的安装位置（称为安装点）。通常，**安装点（mount point）**为空目录。然后，os验证设备是否包含一个有效文件系统。这样可以根据需要可在文件系统之间进行切换。

## 10.5 文件共享（略）

## 10.6 保护

当信息保存在计算机系统中，需要保护其安全，使之不受物理损坏（可靠性）和非法访问（保护）。可靠性通常是由文件备份来提供的。

保护，通过控制访问来实现保护，通过限制可进行的文件访问类型，保护机制可提供控制访问。最常用的方法是**根据用户身份进行控制**。实现基于身份访问的最为普通的方式是为每个文件和目录增加一个**访问控制表**(access-conrtol list, ACL)。每次访问时，OS就检查该文件的ACL看申请的用户在不在ACL中。为了精简访问列表，许多系统为每个文件采用了三种用户类型：
- 拥有者
- 组
- 其他

另一种保护方式是为每个文件加上密码。