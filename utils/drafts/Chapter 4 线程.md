@(Operating System)

# Chapter 4 线程

线程是CPU使用的基本单元，它由线程ID、程序计数器、寄存器集合和栈组成。
进程创建很耗费时间和资源。

多线程编程优点：
1. 响应度高
2. 资源共享
3. 经济
4. 多处理器体系结构的利用

### 4.2 多线程模型

有两种不同方法来提供线程支持：用户层的**用户线程**和内核层的**内核线程**。用户线程（user thread）受内核支持，而无须内核管理；而内核线程（kernel thread）由操作系统直接支持和管理。

最后，在用户线程和内核线程之间必然存在一种关系，就是一下3种。

#### 4.2.1 多对一模型
多对一模型（Many-to-One）将许多用户级线程映射到一个内核线程。

优点：线程管理是由线程库在用户空间进行的，因而效率比较高
缺点：如果一个线程执行了阻塞系统调用，那么整个进程会阻塞，因为任一时刻只有一个线程能访问内核，多个线程不能并行运行在多处理器上。

#### 4.2.2 一对一模型
一对一模型（One-to-One）将每个用户线程映射到一个内核线程

优点：解决了多对一模型的所有缺点（在一个线程执行阻塞系统调用时，能允许另一个线程继续执行）
缺点：由于创建内核线程的开销会影响应用程序的性能，所以这种模型的绝大多数实现限制了系统所支持的线程数量。

#### 4.2.3 多对多模型
多对多模型（Many-to-Many）多路复用了许多用户线程到同样数量或更小数量的内核线程上。开发人员可创建任意多的用户线程，并且相应内核线程能在多处理器系统上并发执行。

优点：上述两种模型的缺点都没有

### 4.4 多线程问题

#### 4.4.1 系统调用fork()和exec()

如果程序中的一个线程调用fork()，有的UNIX系统中有两种形式的fork()，一种新进程会复制所有线程，另一种只复制调用了系统调用fork()的线程。
如果一个线程系统调用exec()，那么exec()参数所指定的程序会替换**整个进程**，包括所有线程。

#### 4.4.2 取消
线程取消（thread cancellation）是在线程完成之前来终止线程的任务。

要取消的线程通常称为**目标线程**。目标线程的取消可在如下两种情况下发生：
1. **异步取消**（asynchronous cancellation）：一个线程立即终止目标线程
2. **延迟取消**（deferred cancellation）：目标线程不断地检查它是否应终止，这允许目标线程有机会以有序方式来终止自己。

#### 4.4.4 线程池
线程池（thread pool）的主要思想是在进程开始时创建一定数量的线程，并放入到池中以等待工作。如果没有可用的，就会阻塞等待。
优点：
1. 通常用现有线程处理请求要比等待创建新的线程要快。
2. 线程池限制了在任何时候可用线程的数量。这对那些不能支持大量并发线程的系统非常重要。

#### 4.4.5 线程特定数据
在有些情况下每个线程可能需要一定数据的自己的副本。这种数据称为线程特定数据（thread-specific data）。

#### 小项目：矩阵乘法

---

小结：
线程是进程内的控制流
用户线程对程序员来说是可见的，而对内核来说是未知的。操作系统支持和管理内核线程。